@page "/intranet/dashboard"
@using DTOs
@inject CriptoVersus.Web.Services.CriptoVersusApiClient Api
@using Microsoft.AspNetCore.SignalR.Client
@inject IJSRuntime JS
<h3 class="mb-3">Dashboard</h3>
@implements IAsyncDisposable

@if (_loading)
{
    <p>Carregando...</p>
}
else if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger">@_error</div>
}
else if (_snapshot is null)
{
    <div class="alert alert-warning">Sem dados do snapshot.</div>
}
else
{
    <!-- Cards: Matches -->
    <div class="row g-3 mb-3">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <div class="text-muted">Pendentes</div>
                    <div class="fs-2 fw-bold">@_snapshot.Matches.Pending</div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <div class="text-muted">Em andamento</div>
                    <div class="fs-2 fw-bold">@_snapshot.Matches.Ongoing</div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <div class="text-muted">Finalizadas (24h)</div>
                    <div class="fs-2 fw-bold">@_snapshot.Matches.CompletedLast24h</div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Worker</h5>
                    <div id="worker-status-badge"></div>
                </div>

                <div class="mt-2" id="worker-health-list"></div>
            </div>
        </div>

    </div>

    <!-- Worker -->
    <div class="card mb-3">
        <div class="card-header d-flex align-items-center justify-content-between">
            <div>
                <strong>@_snapshot.Worker.ServiceName</strong>
                <span class="badge ms-2 @WorkerBadge">
                    @(_snapshot.Worker.IsAlive ? "ONLINE" : "OFFLINE")
                </span>
            </div>

            <button class="btn btn-sm btn-outline-primary" @onclick="Reload">
                Atualizar
            </button>
        </div>

        <div class="card-body">
            <div class="text-muted">
                Server UTC: @_snapshot.ServerTimeUtc.ToString("yyyy-MM-dd HH:mm:ss")
            </div>
            <div class="text-muted">
                Último heartbeat: @FmtUtc(_snapshot.Worker.LastHeartbeatUtc)
            </div>

            <div class="row mt-2">
                <div class="col-md-4 text-muted">Intervalo: <strong>@_snapshot.Worker.CycleIntervalSeconds</strong>s</div>
                <div class="col-md-4 text-muted">Duração match: <strong>@_snapshot.Worker.MatchDurationMinutes</strong> min</div>
                <div class="col-md-4 text-muted">Alvo próximas: <strong>@_snapshot.Worker.TargetUpcomingMatches</strong></div>
            </div>

            <div class="row mt-2">
                <div class="col-md-6 text-muted">Ciclo início: <strong>@FmtUtc(_snapshot.Worker.LastCycleStartUtc)</strong></div>
                <div class="col-md-6 text-muted">Ciclo fim: <strong>@FmtUtc(_snapshot.Worker.LastCycleEndUtc)</strong></div>
            </div>

            @if (!string.IsNullOrWhiteSpace(_snapshot.Worker.LastError))
            {
                <div class="alert alert-warning mt-3 mb-0">
                    <strong>Último erro:</strong> @_snapshot.Worker.LastError
                    <div class="text-muted mt-1">Quando: @FmtUtc(_snapshot.Worker.LastErrorUtc)</div>
                </div>
            }
        </div>
    </div>

    <div class="row g-3">
        <!-- Próximas partidas -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header"><strong>Upcoming</strong></div>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Times</th>
                                <th>Status</th>
                                <th class="text-end">Início</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (_snapshot.Matches.Upcoming.Count == 0)
                            {
                                <tr><td colspan="4" class="text-muted p-3">Nenhuma partida pendente.</td></tr>
                            }
                            else
                            {
                                @foreach (var m in _snapshot.Matches.Upcoming)
                                {
                                    <tr>
                                        <td>@m.MatchId</td>
                                        <td>@m.TeamA <span class="text-muted">vs</span> @m.TeamB</td>
                                        <td>@m.Status</td>
                                        <td class="text-end">@FmtUtc(m.StartTime)</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Partidas em andamento -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header"><strong>Ongoing</strong></div>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Times</th>
                                <th>Placar</th>
                                <th class="text-end">Tempo</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (_snapshot.Matches.OngoingList.Count == 0)
                            {
                                <tr><td colspan="4" class="text-muted p-3">Nenhuma partida em andamento.</td></tr>
                            }
                            else
                            {
                                @foreach (var m in _snapshot.Matches.OngoingList)
                                {
                                    <tr>
                                        <td>@m.MatchId</td>
                                        <td>@m.TeamA <span class="text-muted">vs</span> @m.TeamB</td>
                                        <td>
                                            <div>
                                                <strong>@m.ScoreA</strong> x <strong>@m.ScoreB</strong>
                                            </div>

                                            <div class="text-muted small">
                                                @FmtPct(m.PctA) <span class="text-muted">vs</span> @FmtPct(m.PctB)
                                            </div>
                                        </td>

                                        <td class="text-end">
                                            @m.ElapsedMinutes' <span class="text-muted">(-@m.RemainingMinutes')</span>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Top Gainers -->
        <div class="col-12">
            <div class="card">
                <div class="card-header"><strong>Top Gainers</strong></div>
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Symbol</th>
                                <th>Name</th>
                                <th class="text-end">%</th>
                                <th class="text-end">Atualizado</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (_snapshot.TopGainers.Count == 0)
                            {
                                <tr><td colspan="5" class="text-muted p-3">Sem dados.</td></tr>
                            }
                            else
                            {
                                @foreach (var c in _snapshot.TopGainers)
                                {
                                    <tr>
                                        <td>@c.Rank</td>
                                        <td><strong>@c.Symbol</strong></td>
                                        <td>@c.Name</td>
                                        <td class="text-end text-success fw-bold">+@c.PercentageChange.ToString("0.##")%</td>
                                        <td class="text-end">@FmtUtc(c.LastUpdatedUtc)</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private object? _workerJsPayload;
    private bool _workerJsDirty;
    private bool _interactiveReady;

    private static string FmtPct(decimal? v)
    {
        if (v is null) return "-";
        var sign = v.Value >= 0 ? "+" : "";
        return $"{sign}{v.Value:0.##}%";
    }
    private HubConnection? _hub;

    protected override async Task OnInitializedAsync()
    {
        await Reload();

        _hub = new HubConnectionBuilder()
            .WithUrl("https://criptoversus-api.duckdns.org/hubs/dashboard")
            .WithAutomaticReconnect()
            .Build();

        _hub.On("dashboard_changed", () => InvokeAsync(Reload));

        _hub.Reconnecting += error =>
        {
            _error = "Reconectando ao Hub...";
            return InvokeAsync(StateHasChanged);
        };

        _hub.Reconnected += connectionId =>
        {
            _error = null;
            return InvokeAsync(StateHasChanged);
        };

        _hub.Closed += error =>
        {
            _error = "Conexão do Hub fechada.";
            return InvokeAsync(StateHasChanged);
        };

        try
        {
            await _hub.StartAsync();
        }
        catch (Exception ex)
        {
            _error = $"Hub conectado. ConnectionId={_hub.ConnectionId} State={_hub.State}";
            await InvokeAsync(StateHasChanged);
        }
    }

 

    public async ValueTask DisposeAsync()
    {
        if (_hub != null)
            await _hub.DisposeAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            _interactiveReady = true;

        if (_interactiveReady && _workerJsDirty && _workerJsPayload is not null)
        {
            await JS.InvokeVoidAsync("updateWorkerDashboard", _workerJsPayload);
            _workerJsDirty = false;
        }
    }

    private DashboardSnapshotDto? _snapshot;
    private bool _loading = true;
    private string? _error;

   

    private async Task Reload()
    {
        try
        {
            _loading = true;
            _error = null;

            // já força render do "Carregando..."
            await InvokeAsync(StateHasChanged);

            _snapshot = await Api.GetDashboardSnapshotAsync();


            if (_snapshot?.Worker is not null)
            {
                var secondsSinceHeartbeat =
                    (int)(DateTime.UtcNow - _snapshot.Worker.LastHeartbeatUtc).TotalSeconds;

                var healthJson = System.Text.Json.JsonSerializer.Serialize(new
                {
                    database = new { Ok = _snapshot.Worker.IsAlive, Message = "Heartbeat" },
                    worker = new
                    {
                        Ok = _snapshot.Worker.IsAlive,
                        Message = secondsSinceHeartbeat <= _snapshot.Worker.CycleIntervalSeconds * 2
                            ? "Running"
                            : "Delayed"
                    }
                });

                _workerJsPayload = new
                {
                    tx_health_json = healthJson,
                    in_degraded = !_snapshot.Worker.IsAlive,
                    secondsSinceHeartbeat = secondsSinceHeartbeat,
                    cycleIntervalSeconds = _snapshot.Worker.CycleIntervalSeconds
                };

                _workerJsDirty = true;

                // ✅ se já estamos no modo interativo (browser pronto), pode disparar agora
                if (_interactiveReady)
                {
                    await JS.InvokeVoidAsync("updateWorkerDashboard", _workerJsPayload);
                    _workerJsDirty = false;
                }
            }


        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
            await InvokeAsync(StateHasChanged);
        }
    }


    private string WorkerBadge => _snapshot?.Worker.IsAlive == true ? "bg-success" : "bg-danger";

    private static string FmtUtc(DateTime? dt)
        => dt is null ? "-" : dt.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss");

    private static string FmtUtc(DateTime dt)
        => dt.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss");
}
